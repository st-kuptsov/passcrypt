# PassCrypt

Библиотека для безопасного шифрования и дешифрования ключей с использованием гибридного шифрования (RSA + AES-GCM) и фрагментации ключей для защиты мастер-ключей в условиях отсутствия KMS.
Не является заменой аппаратным модулям безопасности и не защищает от атак на запущенный процесс.

## Описание

PassCrypt - это библиотека на Go, предназначенная для безопасного хранения и передачи паролей. Она использует гибридный подход к шифрованию с комбинацией RSA и AES-GCM, а также уникальную систему фрагментации и маскирования ключей для обеспечения максимальной безопасности.

Основные особенности:

- Гибридное шифрование (RSA-OAEP с SHA-256 + AES-GCM)
- Безопасное хранение приватного ключа с использованием XOR-маскирования
- Фрагментация и шифрование ключей с помощью AES-GCM с Argon2id-производными ключами
- Защита от статического анализа и reverse engineering
- Интеграция с инструментом obfuscation Garble для дополнительной защиты
- Поддержка кэширования ключей для повышения производительности
- 50 фрагментов с перемешиванием и 10 dummy-фрагментами для дополнительной обфускации

## Архитектура безопасности

### Генерация и защита ключей

1. **Генерация RSA-пары ключей** (2048 бит)
2. **Создание XOR-маски** (512 байт случайных данных)
3. **XOR-шифрование приватного ключа** с использованием маски
4. **Разбиение данных на фрагменты**:
   - 16 фрагментов по 32 байта (XOR-маска)
   - 34 фрагмента по 97 байт (зашифрованный приватный ключ)
   - 10 dummy фрагментов по 97 байт (случайные данные)
5. **Перемешивание фрагментов** для дополнительной обфускации
6. **AES-GCM шифрование каждого фрагмента** с уникальным Argon2id-производным ключом
7. **Встраивание зашифрованных фрагментов** в исходный код

### Процесс гибридного шифрования пароля

1. Генерация случайного 256-битного AES-ключа
2. Шифрование пароля с использованием AES-GCM
3. Шифрование AES-ключа с использованием публичного RSA-ключа
4. Объединение зашифрованного AES-ключа, nonce и зашифрованного пароля
5. Кодирование результата в Base64

### Процесс гибридного дешифрования пароля

1. Декодирование из Base64
2. Дешифрование AES-ключа с использованием приватного RSA-ключа
3. Извлечение nonce и зашифрованного пароля
4. Дешифрование пароля с использованием AES-GCM
5. Возврат расшифрованного пароля

## Начало работы

PassCrypt - не обычная библиотека. Приватный ключ вшивается в бинарник, поэтому библиотека должна быть частью вашего проекта.

### Установка

Добавление библиотеки в проект осуществляется через инсталлер, который сгенерирует уникальные ключи шифрования и разместит исходный код в указанной пользователем директории. Установка инсталлера осуществляется командой:

```bash
go install github.com/st-kuptsov/passcrypt/cmd/passcrypt@latest
```

### Генерация кода

Для использования библиотеки необходимо ее инициализировать:

```bash
# Перейдите в корень вашего проекта
cd /path/to/your/project

# Создайте директорию для библиотеки
mkdir -p internal/passcrypt

# Сгенерируйте ключи
passcrypt init -output-dir=./internal/passcrypt
```

#### Поддерживаемые команды:

- `init` - Полная генерация библиотеки с новыми ключами
- `update` - Обновление кода библиотеки с сохранением существующих ключей
- `rekey` - Генерация новых ключей с сохранением существующего кода
- `help` - Показать справку

#### Параметры командной строки:

- `-output-dir` - Директория для генерации библиотеки (по умолчанию: internal/passcrypt)

Примеры использования:

```bash
# Полная генерация в директорию по умолчанию
passcrypt init

# Генерация в пользовательскую директорию
passcrypt init -output-dir=./internal/auth

# Обновление кода с сохранением ключей
passcrypt update -output-dir=./internal/auth

# Генерация новых ключей с сохранением кода
passcrypt rekey -output-dir=./internal/auth
```

**Важно:** Файл `internal/passcrypt/embedded_keys.go` содержит фрагментированные зашифрованные ключи. **НИКОГДА НЕ КОММИТЬТЕ ЭТОТ ФАЙЛ В СИСТЕМУ КОНТРОЛЯ ВЕРСИЙ!**

Файл содержит чувствительные данные, которые даже в зашифрованном виде могут быть использованы для восстановления ключей при достаточном усилии. Всегда добавляйте `internal/passcrypt/embedded_keys.go` в `.gitignore` и убедитесь, что он не попадает в публичные репозитории.

```bash
# Добавьте в .gitignore
echo "internal/passcrypt/embedded_keys.go" >> .gitignore
```

### Ротация ключей

При компрометации бинарника или подозрении на утечку:

```bash
passcrypt rekey -output-dir=./internal/passcrypt
```

После этого все ранее зашифрованные данные становятся недоступны - перешифруйте их новым мастер-ключом.

### Сборка с Garble

Для дополнительной защиты рекомендуется собирать проект с использованием Garble:

```bash
# Установите Garble
go install mvdan.cc/garble@latest

# Соберите проект с обфускацией
garble -tiny -literals -seed=$(head -c48 /dev/urandom | base64) build -ldflags="-s -w" .
```

### Использование библиотеки

После генерации ключей вы можете использовать библиотеку в своем проекте:

```go
package main

import (
    "fmt"
    "log"

    "your-project/internal/passcrypt"
)

func main() {
    // Пароль для шифрования
    password := "MySecretPassword123!"

    // Шифрование пароля
    encrypted, err := passcrypt.Encrypt(password)
    if err != nil {
        log.Fatal("Ошибка шифрования:", err)
    }

    fmt.Println("Зашифрованный пароль:", encrypted)

    // Дешифрование пароля
    decrypted, err := passcrypt.Decrypt(encrypted)
    if err != nil {
        log.Fatal("Ошибка дешифрования:", err)
    }

    fmt.Println("Расшифрованный пароль:", decrypted)
}
```

## API

### `Encrypt(password string) (string, error)`

Шифрования пароля с использованием гибридного подхода (RSA + AES-GCM).

**Параметры:**

- `password` - пароль для шифрования

**Возвращает:**

- Зашифрованный пароль в формате Base64
- Ошибка, если шифрование не удалось

### `Decrypt(encrypted string) (string, error)`

Дешифрования пароля с использованием гибридного подхода (RSA + AES-GCM).

**Параметры:**

- `encrypted` - зашифрованный пароль в формате Base64

**Возвращает:**

- Расшифрованный пароль
- Ошибка, если дешифрование не удалось

## Безопасность

- Приватный ключ никогда не хранится в открытом виде
- Все фрагменты ключей зашифрованы с помощью AES-GCM с Argon2id-производными ключами (64MiB memory-hard)
- XOR-маскирование для дополнительной защиты приватного ключа
- Уникальные соли и ключи для каждого фрагмента
- Использование Garble для обфускации бинарного файла
- Кэширование ключей для повышения производительности
- Гибридное шифрование для поддержки паролей любой длины
- 50 фрагментов с перемешиванием и 10 dummy-фрагментами для дополнительной обфускации

## Ограничения и реалистичные угрозы

PassCrypt **не защищает** от:

- Компрометации запущенного процесса (ptrace, /proc/<pid>/mem, LD_PRELOAD)
- Атак через отладчик на живом сервере
- Извлечения ключа из оперативной памяти после инициализации
- Физического доступа к серверу

Защита работает только против:

- Утечки исходного кода репозитория
- Утечки бинарного файла
- Статического реверс-инжиниринга
- Автоматизированного извлечения ключей из бинарника

## Для чего использовать

Рекомендуемые сценарии:

- Шифрование мастер-ключа для расшифровки данных пользователей
- Хранение зашифрованных refresh-токенов
- Передача секретов между сервисами
- Защита конфиденциальных данных в условиях отсутствия KMS

**Не рекомендуется** для хранения паролей пользователей напрямую - используйте bcrypt/argon2id/scrypt.

## Производительность

- Кэширование ключей после первой инициализации
- Гибридный подход обеспечивает высокую скорость шифрования/дешифрования
- Минимальные накладные расходы на шифрование

## Лицензия

MIT License - см. файл [LICENSE](LICENSE) для подробной информации.

## Автор

Stanislav Kuptsov
